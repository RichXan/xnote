# 1. 什么是跨域

源（origin）就是协议、域名和端口号。

URL由协议、域名、端口和路径组成，如果两个URL的协议、域名和端口全部相同，则表示他们同源。否则，只要协议、域名、端口有任何一个不同，就是跨域。

同源策略：是指协议、域名、端口号都要相同，其中有一个不同都会产生跨域问题。

`跨域测试代码`
```javsscript
var xhr = new XMLHttpRequest();
xhr.open('GET', 'https://www.baidu.com');
xhr.send(null);
xhr.onload = function(e) {
var xhr = e.target;
console.log(xhr.responseText);
}
```

# 2. nginx是什么
**Nginx** **(engine x)** 是一款轻量级的Web 服务器 、反向代理服务器及电子邮件（IMAP/POP3）代理服务器。

## **反向代理：**
反向代理（Reverse Proxy）方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。

## **正向代理:**
是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端才能使用正向代理。


## 正向代理和反向代理区别？
**正向代理**，是在客户端的。比如需要访问某些国外网站，我们可能需要购买vpn。并且**vpn是在我们的用户浏览器端设置的**(并不是在远端的服务器设置)。浏览器先访问vpn地址，vpn地址转发请求，并最后将请求结果原路返回来。
![](https://pic1.zhimg.com/v2-c6713b1f540d8f75c52ca7f5f3e5d720_b.jpg)

**反向代理是作用在服务器端的，是一个虚拟ip(VIP)**。对于用户的一个请求，会转发到多个后端处理器中的一台来处理该具体请求。
![](https://pic3.zhimg.com/v2-8d61569186e7c31940eccd1953fafaa6_b.jpg)



# 3. 如何解决跨域问题

## 3.1 不跨域
![](https://upload-images.jianshu.io/upload_images/9487719-bcddb4ac905f055a.png?imageMogr2/auto-orient/strip|imageView2/2/w/651/format/webp)

首先我们用nginx作为代理服务器和用户交互，这样用户就只需要在80端口上进行交互就可以了，这样就避免了跨域问题，因为我们都是在80端口上进行交互的；

1.当用户发送localhost:80/时会被nginx转发到http://localhost:81服务；

2.当界面请求接口数据时，只要以/apis 为开头，就会被nginx转发到后端接口服务器上；

总结：nginx实现跨域的原理，实际就是把web项目和后端接口项目放到一个域中，这样就不存在跨域问题，然后根据请求地址去请求不同服务器（真正干活的服务器）；



# 4. k8s解决跨域问题
在项目中添加注解
```bash
kubernetes.io/ingress.class: nginx
nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
nginx.ingress.kubernetes.io/cors-allow-headers: '*'
nginx.ingress.kubernetes.io/cors-allow-methods: PUT, GET, POST, OPTIONS, DELETE
nginx.ingress.kubernetes.io/cors-allow-origin: http://test-admin.d.rrinner.cn   （ 指定域名）
nginx.ingress.kubernetes.io/enable-cors: "true"
```


# 5. kubesphere
rewrite-api yaml文件
```yaml
kind: Ingress
apiVersion: networking.k8s.io/v1
metadata:
  name: rewrite-api
  namespace: seanet-test
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: >
      {"apiVersion":"networking.k8s.io/v1","kind":"Ingress","metadata":{"annotations":{"nginx.ingress.kubernetes.io/Access-Control-Allow-Origin":"*","nginx.ingress.kubernetes.io/cors-allow-headers":"DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization","nginx.ingress.kubernetes.io/cors-allow-methods":"PUT,GET,POST,OPTIONS,DELETE","nginx.ingress.kubernetes.io/cors-allow-origin":"*","nginx.ingress.kubernetes.io/enable-cors":"true","nginx.ingress.kubernetes.io/rewrite-target":"/$2","nginx.ingress.kubernetes.io/service-weight":""},"name":"rewrite-api","namespace":"seanet-test"},"spec":{"ingressClassName":"nginx","rules":[{"host":"test.sealan.tech","http":{"paths":[{"backend":{"service":{"name":"seanet","port":{"number":18000}}},"path":"/api(/|$)(.*)","pathType":"Prefix"}]}}]}}
    nginx.ingress.kubernetes.io/Access-Control-Allow-Origin: '*'
    nginx.ingress.kubernetes.io/cors-allow-credentials: 'true'
    nginx.ingress.kubernetes.io/cors-allow-headers: >-
      DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization
    nginx.ingress.kubernetes.io/cors-allow-methods: 'PUT, GET, POST, OPTIONS, DELETE'
    nginx.ingress.kubernetes.io/cors-allow-origin: '*'
    nginx.ingress.kubernetes.io/enable-cors: 'true'
    nginx.ingress.kubernetes.io/service-weight: ''
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  ingressClassName: nginx
  rules:
    - host: test.sealan.tech
      http:
        paths:
          - path: /api(/|$)(.*)
            pathType: Prefix
            backend:
              service:
                name: seanet
                port:
                  number: 18000

```

https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#enable-cors



 我在服务中配置了开启跨域的注释，解决了其他源访问时，跨域的问题。
 但是现在我在这个服务中去服务不同源的网站时，还是有跨域这个问题。

```
{id: 21, name: '测试平台', platform_type: 'mqtt', platform_config: {…}, updatedat: '2022-09-01T17:53:50.978857Z', …}

[{lable:id,value:21}]

arr.forEach((val,key) => console.log(val,key))

```

